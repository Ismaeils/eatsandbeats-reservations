// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model RestaurantUser {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  restaurant Restaurant?
  
  @@map("restaurant_users")
}

model Restaurant {
  id                 String   @id @default(cuid())
  userId             String   @unique
  name               String
  logoUrl            String?
  address            String
  reservationDeposit Float    @default(0)
  averageSeatingTime Int      @default(60) // in minutes
  reservationDuration Int     @default(120) // default reservation duration in minutes
  slotGranularity    Int      @default(15) // time slot granularity in minutes
  tableLayout        String[] // Array of table identifiers like ["T1", "T2", "TB01"]
  cuisines           String[] // Array of cuisine types
  hasVisualLayout    Boolean  @default(false) // Whether restaurant uses visual floor plan
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  
  user               RestaurantUser @relation(fields: [userId], references: [id], onDelete: Cascade)
  reservations       Reservation[]
  invitations        ReservationInvitation[]
  openingHours       OpeningHours[]
  exceptionalDates   ExceptionalDate[]
  floorPlans         FloorPlan[]
  
  @@map("restaurants")
}

// Visual floor plan for restaurant layout
model FloorPlan {
  id           String   @id @default(cuid())
  restaurantId String
  name         String   // e.g., "Ground Floor", "Rooftop", "Patio"
  order        Int      @default(0) // Display order for multiple floors
  width        Int      @default(800) // Canvas width in pixels
  height       Int      @default(600) // Canvas height in pixels
  elements     Json     // JSON array of floor plan elements (tables, dividers, decorations)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  
  @@map("floor_plans")
}

// Regular opening hours for each day of the week
model OpeningHours {
  id           String   @id @default(cuid())
  restaurantId String
  dayOfWeek    Int      // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
  isOpen       Boolean  @default(true)
  openTime     String?  // Format: "HH:mm" e.g., "09:00"
  closeTime    String?  // Format: "HH:mm" e.g., "22:00"
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  
  @@unique([restaurantId, dayOfWeek])
  @@map("opening_hours")
}

// Exceptional dates (holidays, special events, etc.)
model ExceptionalDate {
  id           String   @id @default(cuid())
  restaurantId String
  date         DateTime @db.Date // The specific date
  isOpen       Boolean  @default(false) // Whether open on this date
  openTime     String?  // Format: "HH:mm" - overrides regular hours
  closeTime    String?  // Format: "HH:mm" - overrides regular hours
  note         String?  // Optional note (e.g., "Christmas Day")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  
  @@unique([restaurantId, date])
  @@map("exceptional_dates")
}

model ReservationInvitation {
  id            String   @id @default(cuid())
  restaurantId  String
  phoneNumber   String
  status        InvitationStatus @default(PENDING)
  invitationType InvitationType @default(WHATSAPP)
  webFormToken  String?  @unique // Unique token for web form link
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  expiresAt     DateTime?
  
  restaurant    Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  reservation   Reservation?
  
  @@map("reservation_invitations")
}

model Reservation {
  id                String   @id @default(cuid())
  restaurantId      String
  invitationId      String?  @unique
  guestName         String
  guestContact      String   // phone or email
  numberOfPeople    Int
  timeFrom          DateTime
  timeTo            DateTime
  tableId           String?  // Table identifier from tableLayout
  status            ReservationStatus @default(CONFIRMED)
  depositPaid       Boolean  @default(false)
  depositAmount     Float
  paymentGateway    String?  // e.g., "stripe", "paymob"
  paymentReference  String?  // Payment transaction reference
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  restaurant        Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  invitation        ReservationInvitation? @relation(fields: [invitationId], references: [id])
  
  @@map("reservations")
}

enum InvitationStatus {
  PENDING
  SENT
  COMPLETED
  EXPIRED
}

enum InvitationType {
  WHATSAPP
  SMS
  WEB_FORM
}

enum ReservationStatus {
  PENDING
  CONFIRMED
  SEATED
  COMPLETED
  CANCELLED
}
