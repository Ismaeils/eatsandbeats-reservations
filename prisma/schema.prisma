// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  RESTAURANT
  ADMIN
  OWNER
  MANAGER
  STAFF
}

model RestaurantUser {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  role      UserRole @default(RESTAURANT)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  restaurant Restaurant?
  
  @@map("restaurant_users")
}

model AdminUser {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("admin_users")
}

model Restaurant {
  id                        String   @id @default(cuid())
  userId                    String   @unique
  name                      String
  logoUrl                   String?
  address                   String
  reservationDeposit        Float    @default(0)
  averageSeatingTime        Int      @default(60) // in minutes
  reservationDuration       Int      @default(120) // default reservation duration in minutes
  slotGranularity           Int      @default(15) // time slot granularity in minutes
  maxSimultaneousReservations Int    @default(10) // max reservations at same time slot
  autoConfirmReservations   Boolean  @default(false) // Auto-confirm or require manual approval
  cuisines                  String[] // Array of cuisine types
  isPublished               Boolean  @default(false) // Whether restaurant is visible to public
  country                   String   @default("UAE") // Restaurant country
  language                  String   @default("en")  // Restaurant language
  currency                  String   @default("AED") // Restaurant currency
  description               String?  // Restaurant description
  photos                    String[] // Up to 5 photo URLs for listing
  phone                     String?  // Contact phone number
  email                     String?  // Contact email
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt
  
  user               RestaurantUser @relation(fields: [userId], references: [id], onDelete: Cascade)
  reservations       Reservation[]
  invitations        ReservationInvitation[]
  openingHours       OpeningHours[]
  exceptionalDates   ExceptionalDate[]
  
  @@map("restaurants")
}

// Regular opening hours for each day of the week
model OpeningHours {
  id           String   @id @default(cuid())
  restaurantId String
  dayOfWeek    Int      // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
  isOpen       Boolean  @default(true)
  openTime     String?  // Format: "HH:mm" e.g., "09:00"
  closeTime    String?  // Format: "HH:mm" e.g., "22:00"
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  
  @@unique([restaurantId, dayOfWeek])
  @@map("opening_hours")
}

// Exceptional dates (holidays, special events, etc.)
model ExceptionalDate {
  id           String   @id @default(cuid())
  restaurantId String
  date         DateTime @db.Date // The specific date
  isOpen       Boolean  @default(false) // Whether open on this date
  openTime     String?  // Format: "HH:mm" - overrides regular hours
  closeTime    String?  // Format: "HH:mm" - overrides regular hours
  note         String?  // Optional note (e.g., "Christmas Day")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  
  @@unique([restaurantId, date])
  @@map("exceptional_dates")
}

model ReservationInvitation {
  id            String   @id @default(cuid())
  restaurantId  String
  phoneNumber   String
  status        InvitationStatus @default(PENDING)
  invitationType InvitationType @default(WHATSAPP)
  webFormToken  String?  @unique // Unique token for web form link
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  expiresAt     DateTime?
  
  restaurant    Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  reservation   Reservation?
  
  @@map("reservation_invitations")
}

model Reservation {
  id                String   @id @default(cuid())
  restaurantId      String
  invitationId      String?  @unique
  confirmationCode  String?  @unique
  guestName         String
  guestContact      String   // phone or email
  numberOfPeople    Int
  timeFrom          DateTime
  timeTo            DateTime
  status            ReservationStatus @default(PENDING)
  depositPaid       Boolean  @default(false)
  depositAmount     Float
  paymentGateway    String?  // e.g., "stripe", "paymob"
  paymentReference  String?  // Payment transaction reference
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  restaurant        Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  invitation        ReservationInvitation? @relation(fields: [invitationId], references: [id])
  
  @@map("reservations")
}

enum InvitationStatus {
  PENDING
  SENT
  COMPLETED
  EXPIRED
}

enum InvitationType {
  WHATSAPP
  SMS
  WEB_FORM
}

enum ReservationStatus {
  PENDING
  CONFIRMED
  SEATED
  COMPLETED
  CANCELLED
}

enum RequestStatus {
  PENDING
  APPROVED
  DECLINED
}

model RestaurantRequest {
  id               String        @id @default(cuid())
  email            String
  contactName      String
  phone            String
  description      String
  status           RequestStatus @default(PENDING)
  approvalCode     String?       @unique
  approvalCodeUsed Boolean       @default(false)
  declineReason    String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  
  @@map("restaurant_requests")
}
